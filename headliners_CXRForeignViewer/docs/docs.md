# Документация проекта Headliners #

## 1. Архитектура и методы ##

+ Модель: YOLO v8s
+ Тип задачи: Object Detection (обнаружение объектов)
+ Фреймворк: Ultralytics YOLO с CLI интерфейсом

### Архитектура для решения задачи object-detection

В основе нашего решения лежит модель YOLO, которой присущи следующие характеристики:

✅ Backbone (Базовая сеть)

+ Цель: Извлечение признаков из входного изображения.
+ Реализация: Сверточная сеть (CSPDarknet с использованием C2f-модуля).

✅ Neck (Шея)

+ Цель: Агрегация и комбинирование признаков с разных уровней для улучшения детекции объектов разного масштаба.
+ Реализация: PAN-FPN (Path Aggregation Network - Feature Pyramid Network) (также с использованием C2f-модулей)

✅ Head (Голова)

+ Цель: Финальное предсказание.
+ Реализация: Набор сверточных слоев, которые предсказывают:
    1. Bounding Boxes (ограничивающие рамки): Координаты (x, y, width, height) и уверенность (confidence score).
    2. Classes (Классы): Вероятность принадлежности объекта к каждому из классов.

Наше решение существенно расширило возможности YOLO для детекции инородных тел на снимках грудной клетки - за счёт обучения на нескольких вариантах аугментации изображений и аугментировании данных для детекции во время предобработки с последующим слиянием результатов, что даёт куда более точную картину и делает возможной обработку в том числе изображений плохого качества. 

### Структура библиотеки `headliners_CXRForeignViewer`

Библиотека `headliners_CXRForeignViewer` состоит из трех основных модулей:

1. config

    Содержит переменные для настройки путей проекта. Обязательно настройте этот файл при запуске модели в режиме обучения. При запуске скрипта в режиме детекции скрипт сам запросит директорию, где хранятся DICOM файлы. 

2. lib

    Подмодули:
    + augmentation - методы аугментации, использованные для подготовки train и test датасетов перед запуском модели в режиме обучения. Для обработки использовались фильтры `CLAHE`, `DCP`, а также `комбинации` этих фильтров с различными параметрами.
    + file_management - методы файлового менеджмента, использованные командой разработчиков для подготовки датасетов. Данный модуль делает возможной рекурсивную обработку директории, содержащей данные, целиком. Наличие вложенных папок не является препятствием для работы модели. 
    + image_processing - методы, использованные для предобработки данных перед запуском модели в train или predict моде.
    + model_mapper - класс модели, позволяющий легко и удобно использовать её функционал.
    + postprocess - методы, использованные для постобработки результата модели.
    + metrics - методы расчёта метрик для оценки моделей.

3. model

    Модель, обученная командой. Директория содержит как параметры модели, так и описание её характеристик и эпох обучения, а также диаграммы.

4. scripts

    Демонстрационные скрипты. Содержит скрипт, показывающий работу метода `predict` модели `YoloViewer`.

5. interactive_detector

    Это самостоятельный модуль с графическим интерфейсом, специально разработанный командой для удобной разметки DICOM изображений. Он позволяет:
    + В интерактивном режиме размечать снимки с помощью боксов.
    + Накладывать на исходное изображение различные фильтры аугментации без непосредственного его изменения.
    + Автоматически получать координаты и параметры каждого боква.
    + Сохранять разметку в требуемом формате. 

6. demo_files

    Директория с примерами файлов для демонстрации работы решения. `Важно!` Демонстрационные файлы DICOM не предполагают использования этой директории для запуска модели в режиме обучения, несмотря на то, что помимо DICOM файлов директория содержит пример файла dataset.yaml.

7. docs

    Документация по проекту.

8. Демонстрационные скрипты и блокноты.

    Запуск решения возможен с помощью файлов `main.py`, `detect.ipynb`, `detect_autonomous.ipynb`. Подробнее см. `README.md`. 

9. Результаты работы модели

    Результаты работы модели по дефолту помещаются в папку `results` и файл бинарной классификации `result.xlsx`. Эти пути можно настроить через `config`. 



## 2. Данные ##

**Структура данных**

Программа принимает для работы путь к папке и работает только с изображениями в формате DICOM. Наличие внутри папки вложенных не является препятствием для работы модели. 

+ Структура обучающего датасета:
    + Исходные файлы;
    + Файлы с применённой к ним аугментацией;
    + Инвертированные копии файлов из категорий, указанных выше.


**Разделение данных**

Обучающий датасет был разбит на:

+ Train детасет, из которого
    + 80% файлов для первичного обучения модели
    + 20% файлов - валидация
+ Test датасет

Для более эффективного разделения применялось стратифицированное перемешивание с фиксированным random_seed=42. 

## 3. Обоснование выбора методов ##

Скорость:
Точность:

Препроцессинг

## 4. Процесс обучения ##

**Параметры обучения**

Модель обучалась со следующими параметрами: 

task=detect 
mode=train 
epochs: 100
imgsz: 640
batch: 8
conf=0.25

**Обработка данных**
Аугментация данных

## 5. Методы оценки и результаты тестирования ##

**Основные метрики**

Для расчёта метрик модели использовался инструмент ClearML. Мы оценивали следующие метрики:

+ Precision: Точность обнаружения
+ Recall: Полнота обнаружения
+ F1-score: Гармоническое среднее
+ mAP: Mean Average Precision
+ ROC-AUC: Площадь под ROC-кривой

**Функции расчета метрик**

def calculate_iou(box1, box2):
    # Расчет Intersection over Union

def calculate_precision_recall(pred_boxes, true_boxes, iou_threshold=0.5):
    # Расчет precision и recall

def calculate_map(predictions, targets, iou_threshold=0.5):
    # Расчет mean Average Precision

def calculate_detection_roc_auc(predictions, targets, iou_threshold=0.5):
    # Расчет ROC-AUC для детекции

**Результаты тестирования**

text
Precision: X.XXX
Recall: X.XXX
F1: X.XXX
mAP: X.XXX
ROC-AUC: X.XXX

## 6. Заключение ##

Разработанная система демонстрирует высокую эффективность в обнаружении инородных тел на рентгенограммах ОГК. Усовершенствование архитектуры YOLO позволило достичь баланса между точностью и скоростью работы, что важно для клинического применения.

## 7. Дорожная карта ##

Куда же мы двигаемся дальше? 

Для повышения точности модели в дальнейшем возможно:
+ Расширение датасета за счёт увеличения методов аугментации. Это требует большего времени на тестирование результатов.
+ Расширение исходной обучающей базы. Осложнено политикой конфиденциальности в отношении медицинских данных, которая влияет на доступность датасетов.
+ Переход на модели старшего поколения с увеличением времени обучения. Требует значительных временных затрат и мощностей GPU.
+ Увеличение количества вариантов разметки. Это требует привлечения большего числа специалистов в области медицины и времени на тестирование.
+ Добавление функции мультиклассовой детекции для распознавания типа инородного объекта. Требует более широкой выборки данных и более длительного обучения.
